#!/bin/bash
#
# ckg-consumer        CKG Consumer Service
#
# chkconfig: 2345 90 10
# description: CKG Consumer service for processing messages from Pub/Sub
# processname: ckg-consumer
# pidfile: /var/run/ckg-consumer.pid

### BEGIN INIT INFO
# Provides:          ckg-consumer
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: CKG Consumer Service
# Description:       CKG Consumer service for processing messages from Pub/Sub
### END INIT INFO

# Source function library
if [ -f /etc/rc.d/init.d/functions ]; then
    . /etc/rc.d/init.d/functions
elif [ -f /lib/lsb/init-functions ]; then
    . /lib/lsb/init-functions
fi

# Configuration
NAME="ckg-consumer"
DESC="CKG Consumer Service"
CONSUMER_SCRIPT="/opt/sitb-ckg/scripts/consumer/run-consumer.sh"
PIDFILE="/var/run/${NAME}.pid"
LOGFILE="/var/log/${NAME}.log"

# Check if consumer script exists
if [ ! -f "$CONSUMER_SCRIPT" ]; then
    echo "Error: Consumer script not found: $CONSUMER_SCRIPT"
    exit 1
fi

# Make sure the script is executable
chmod +x "$CONSUMER_SCRIPT" 2>/dev/null

# Get process ID
get_pid() {
    if [ -f "$PIDFILE" ]; then
        cat "$PIDFILE"
    fi
}

# Check if process is running
is_running() {
    local pid=$(get_pid)
    if [ -n "$pid" ]; then
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

# Start the service
do_start() {
    echo -n "Starting $DESC: "
    
    if is_running; then
        echo "already running (PID: $(get_pid))"
        return 0
    fi
    
    # Start the consumer in background
    nohup "$CONSUMER_SCRIPT" >> "$LOGFILE" 2>&1 &
    local pid=$!
    
    # Save PID
    echo $pid > "$PIDFILE"
    
    # Give it a moment to start
    sleep 1
    
    if is_running; then
        echo "started (PID: $pid)"
        return 0
    else
        echo "failed to start"
        rm -f "$PIDFILE"
        return 1
    fi
}

# Stop the service
do_stop() {
    echo -n "Stopping $DESC: "
    
    if ! is_running; then
        echo "not running"
        rm -f "$PIDFILE"
        return 0
    fi
    
    local pid=$(get_pid)
    
    # Try graceful shutdown first
    kill -TERM "$pid" 2>/dev/null
    
    # Wait for process to terminate
    local count=0
    while is_running && [ $count -lt 30 ]; do
        sleep 1
        count=$((count + 1))
    done
    
    # Force kill if still running
    if is_running; then
        echo -n "force killing... "
        kill -KILL "$pid" 2>/dev/null
        sleep 1
    fi
    
    if is_running; then
        echo "failed to stop"
        return 1
    else
        echo "stopped"
        rm -f "$PIDFILE"
        return 0
    fi
}

# Restart the service
do_restart() {
    echo "Restarting $DESC: "
    do_stop
    sleep 2
    do_start
}

# Reload the service
do_reload() {
    echo -n "Reloading $DESC: "
    
    if ! is_running; then
        echo "not running"
        return 1
    fi
    
    local pid=$(get_pid)
    kill -HUP "$pid" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "reloaded"
        return 0
    else
        echo "failed to reload"
        return 1
    fi
}

# Get service status
do_status() {
    if is_running; then
        local pid=$(get_pid)
        echo "$DESC is running (PID: $pid)"
        return 0
    else
        echo "$DESC is not running"
        return 1
    fi
}

# Main script logic
case "$1" in
    start)
        do_start
        exit $?
        ;;
    stop)
        do_stop
        exit $?
        ;;
    restart)
        do_restart
        exit $?
        ;;
    reload|force-reload)
        do_reload
        exit $?
        ;;
    status)
        do_status
        exit $?
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|reload|force-reload|status}"
        exit 1
        ;;
esac

exit 0
