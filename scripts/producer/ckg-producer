#!/bin/bash

TARGET_DIR="/opt/sitb-ckg"

# CKG Producer Script
# Usage: $TARGET_DIR/ckg-producer [pubsub|api]

# Check if PHP is installed
PHPEXEC=`which php`
if [ -z "$PHPEXEC" ]; then
    echo "Error: PHP not found."
    exit 1
fi

# Check if the PHP executable exists and is executable
if [ ! -x "$PHPEXEC" ]; then
    echo "Error: PHP executable not found or not executable: $PHPEXEC"
    exit 1
fi

# Get service type from argument
SERVICE_TYPE=$1

# Validate service type
if [ -z "$SERVICE_TYPE" ]; then
    cd "$TARGET_DIR"
    MODE=`php -r '$config=require("./config.php"); echo $config["producer_mode"];'`
    if [ "$MODE" = "pubsub" ] || [ "$MODE" = "api" ]; then
        SERVICE_TYPE=$MODE
    else
        SERVICE_TYPE="api"
    fi
fi

if [ "$SERVICE_TYPE" != "pubsub" ] && [ "$SERVICE_TYPE" != "api" ]; then
    echo "Error: Invalid service type '$SERVICE_TYPE'."
    echo "Usage: $0 [pubsub|api]"
    echo ""
    echo "Examples:"
    echo "  $0 pubsub  - Run pubsub producer"
    echo "  $0 api     - Run api producer"
    exit 1
fi

# Set service-specific files
PIDFILE="/var/run/ckg-producer-${SERVICE_TYPE}.pid"
LOGFILE="/var/log/sitb-ckg/producer-${SERVICE_TYPE}.log"
PRODUCER_SCRIPT="$TARGET_DIR/producer.php"

# Check if producer script exists
if [ ! -f "$PRODUCER_SCRIPT" ]; then
    echo "Error: Producer script not found: $PRODUCER_SCRIPT"
    exit 1
fi

# Make sure the script is executable
chmod +x "$PRODUCER_SCRIPT" 2>/dev/null

# Get process ID
get_pid() {
    if [ -f "$PIDFILE" ]; then
        cat "$PIDFILE"
    fi
}

# Check if process is running
is_running() {
    local pid=$(get_pid)
    if [ -n "$pid" ]; then
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

# Start the producer
echo "Starting CKG Producer (${SERVICE_TYPE})..."
echo "Using PHP: $PHPEXEC"
echo "Log file: $LOGFILE"
echo "PID file: $PIDFILE"

if is_running; then
    echo "Error: Producer is already running (PID: $(get_pid))"
    exit 1
fi

# Start the producer in background with service type argument
CMD="php -f $PRODUCER_SCRIPT - --mode=$SERVICE_TYPE"
echo "Run: $CMD"
nohup $CMD 2>&1 &
pid=$!

# Save PID
echo "Producer started with PID: $pid"
echo $pid > "$PIDFILE"

# Give it a moment to start
sleep 2

if is_running; then
    echo "Producer still running"
else
    rm -f "$PIDFILE"
fi

exit 0
